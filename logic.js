const main=document.getElementById("main"),outputElement=document.getElementById("output"),pdf_input=document.getElementById("input"),preview_container=document.getElementById("preview_container"),preview_canvas=document.getElementById("preview_canvas"),_c_preview_view=document.getElementById("_c_preview_view"),_c_preview_hide=document.getElementById("_c_preview_hide"),_c_preview_wipe=document.getElementById("_c_preview_wipe"),_c_preview_reset=document.getElementById("_c_preview_reset"),_c_preview_delete=document.getElementById("_c_preview_delete"),_c_move_doc_left=document.getElementById("_c_move_doc_left"),_c_move_doc_right=document.getElementById("_c_move_doc_right"),config_container=document.getElementById("config_container"),multipage_help=document.getElementById("multipage_help"),multipage_prev=document.getElementById("multipage_prev"),multipage_next=document.getElementById("multipage_next"),multipage_count=document.getElementById("multipage_count"),action_button=document.getElementById("action_button");var fileBuffers=[],PDFDocs=[],num_pages=[],renderInProgress=!1;function whatDoc(e){var t=0,n=e;for(let e=0;e<PDFDocs.length;e++){if(!(n>num_pages[e]))return t;n-=num_pages[e],t++}}function whatPage(e){var t=e;for(let e=0;e<PDFDocs.length;e++){if(!(t>num_pages[e]))return t;t-=num_pages[e]}}async function renderPDFPage(e){var t,n=e;for(let e=0;e<PDFDocs.length;e++){if(!(n>num_pages[e])){t=await PDFDocs[e].getPage(n);break}n-=num_pages[e]}const i=t.getViewport({scale:CONST_DPI/72});canvas.width=i.width>=600?600:i.width,canvas.height=i.height>=600?600:i.height,vCanvas.width=i.width,vCanvas.height=i.height;const o=t.render({canvasContext:vContext,viewport:i});await o.promise}function updatePageCount(){multipage_count.innerHTML="p:"+whatPage(mainStruct.current)+"/"+num_pages[whatDoc(mainStruct.current)]+", ",multipage_count.innerHTML+="d:"+(whatDoc(mainStruct.current)+1)+"/"+(whatDoc(mainStruct.total)+1)+", ",multipage_count.innerHTML+="t:"+mainStruct.current+"/"+mainStruct.total}function getLineCount(e){return e.value.split("\n").length-1}function resizeOutput(e){e.style.height="calc(1.2rem * "+getLineCount(e)+" + 70px)"}function clearOutput(e){e.value=""}clearOutput(outputElement);const canvas=document.getElementById("canvas"),context=canvas.getContext("2d");context.imageSmoothingEnabled=!1;const vCanvas=document.createElement("canvas"),vContext=vCanvas.getContext("2d");vContext.imageSmoothingEnabled=!1;const CONST_DPI=144,CONST_ZOOMFACTOR=1.1,CONST_MOBILEZOOMFACTOR=1.05;function draw(){context.setTransform(1,0,0,1,0,0),context.clearRect(0,0,canvas.width,canvas.height),context.imageSmoothingEnabled=!1,context.setTransform(previewWindow.scale,0,0,previewWindow.scale,previewWindow.offsetX,previewWindow.offsetY),context.drawImage(vCanvas,0,0)}function press(e,t){const n=canvas.getBoundingClientRect();previewWindow.isDragging=!0,previewWindow.isTouchZooming=!1,previewWindow.lastX=e-n.left,previewWindow.lastY=t-n.top}function move(e,t){if(!previewWindow.isDragging||previewWindow.isTouchZooming)return;const n=canvas.getBoundingClientRect(),i=e-n.left-previewWindow.lastX,o=t-n.top-previewWindow.lastY;previewWindow.offsetX+=i,previewWindow.offsetY+=o,previewWindow.lastX=e-n.left,previewWindow.lastY=t-n.top,draw()}function zoom(e){const t=canvas.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,o=e.deltaY<=0?1.1:1/1.1,a=(n-previewWindow.offsetX)/previewWindow.scale,c=(i-previewWindow.offsetY)/previewWindow.scale;previewWindow.scale*=o,previewWindow.offsetX=n-a*previewWindow.scale,previewWindow.offsetY=i-c*previewWindow.scale,draw()}function end(){previewWindow.isDragging=!1,canvas.classList.remove("grabbing")}function getTouchesDist(e,t){const n=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.hypot(n,i)}function getTouchesX(e,t){return(e.clientX+t.clientX)/2}function getTouchesY(e,t){return(e.clientY+t.clientY)/2}function mobileStartZoom(e,t){previewWindow.isDragging=!1,previewWindow.isTouchZooming=!0,previewWindow.lastTouchesDist=getTouchesDist(e,t)}function mobileZoom(e,t){const n=canvas.getBoundingClientRect(),i=getTouchesX(e,t)-n.left,o=getTouchesY(e,t)-n.top,a=getTouchesDist(e,t)-previewWindow.lastTouchesDist<=0?1/1.05:1.05,c=(i-previewWindow.offsetX)/previewWindow.scale,r=(o-previewWindow.offsetY)/previewWindow.scale;previewWindow.scale*=a,previewWindow.offsetX=i-c*previewWindow.scale,previewWindow.offsetY=o-r*previewWindow.scale,previewWindow.lastTouchesDist=getTouchesDist(e,t),draw()}function mobileEnd(){previewWindow.isDragging=!1,previewWindow.isTouchZooming=!1}var previewWindow={scale:1,lastTouchesDist:0,lastX:0,lastY:0,offsetX:0,offsetY:0,isDragging:!1,isTouchZooming:!1};function resetPreviewWindow(){previewWindow={scale:1,lastTouchesDist:0,lastX:0,lastY:0,offsetX:0,offsetY:0,isDragging:!1,isTouchZooming:!1}}var mainStruct={current:1,total:1};function resetMainStruct(e){mainStruct={current:1,total:e}}function action(){clearOutput(outputElement),resizeOutput(outputElement),(async()=>{const{PDFDocument:e}=PDFLib,t=await await e.create();for(const n of fileBuffers){const i=await e.load(n);(await t.copyPages(i,i.getPageIndices())).forEach((e=>t.addPage(e)))}newBytes=await t.save();const n=new Blob([newBytes],{type:"application/pdf"}),i=document.createElement("a");i.href=URL.createObjectURL(n),i.download="merged.pdf",i.click(),URL.revokeObjectURL(i.href)})()}pdfjsLib.GlobalWorkerOptions.workerSrc="pdf.worker.min.js",pdf_input.onchange=async e=>{clearOutput(outputElement),config_container.classList.add("hidden"),multipage_help.classList.add("hidden");const t=e.target.files;if(!(!t||t.length<=1||t.length>=20)){for(const e of t){if("application/pdf"!==e.type)continue;const t=await e.arrayBuffer();fileBuffers.push(t.slice(0)),PDFDocs.push(await pdfjsLib.getDocument({data:t}).promise)}var n=0;for(const e of PDFDocs)num_pages.push(e.numPages),n+=e.numPages;resetMainStruct(n),resetPreviewWindow(),renderInProgress=!0,await renderPDFPage(1),draw(),renderInProgress=!1,config_container.classList.remove("hidden"),multipage_help.classList.remove("hidden"),updatePageCount()}},canvas.addEventListener("wheel",(e=>{e.preventDefault(),zoom(e)})),canvas.addEventListener("mousedown",(e=>{canvas.classList.add("grabbing"),press(e.clientX,e.clientY)})),canvas.addEventListener("mousemove",(e=>{e.preventDefault(),move(e.clientX,e.clientY)})),canvas.addEventListener("mouseup",(()=>{end()})),canvas.addEventListener("mouseleave",(()=>{end()})),canvas.addEventListener("touchstart",(function(e){e.preventDefault(),1==e.touches.length?press(e.touches[0].clientX,e.touches[0].clientY):2==e.touches.length&&mobileStartZoom(e.touches[0],e.touches[1])}),{passive:!1}),canvas.addEventListener("touchmove",(function(e){e.preventDefault(),1==e.touches.length?move(e.touches[0].clientX,e.touches[0].clientY):2==e.touches.length&&mobileZoom(e.touches[0],e.touches[1])}),{passive:!1}),canvas.addEventListener("touchend",(()=>{mobileEnd()}),{passive:!1}),canvas.addEventListener("touchcancel",(()=>{mobileEnd()}),{passive:!1}),_c_preview_view.addEventListener("click",(function(){preview_container.classList.toggle("hidden"),main.classList.toggle("blurred")})),_c_preview_hide.addEventListener("click",(function(){preview_container.classList.toggle("hidden"),main.classList.toggle("blurred")})),multipage_prev.addEventListener("click",(async function(){1==mainStruct.current||renderInProgress||(renderInProgress=!0,mainStruct.current-=1,await renderPDFPage(mainStruct.current),draw(),updatePageCount(),renderInProgress=!1)})),multipage_next.addEventListener("click",(async function(){mainStruct.current==mainStruct.total||renderInProgress||(renderInProgress=!0,mainStruct.current+=1,await renderPDFPage(mainStruct.current),draw(),updatePageCount(),renderInProgress=!1)})),_c_move_doc_left.addEventListener("click",(async function(){let e=whatDoc(mainStruct.current);if(0!=e&&!renderInProgress){renderInProgress=!0;const t=fileBuffers[e],n=PDFDocs[e],i=num_pages[e];fileBuffers[e]=fileBuffers[e-1],PDFDocs[e]=PDFDocs[e-1],num_pages[e]=num_pages[e-1],fileBuffers[e-1]=t,PDFDocs[e-1]=n,num_pages[e-1]=i,await renderPDFPage(mainStruct.current),draw(),updatePageCount(),renderInProgress=!1}})),_c_move_doc_right.addEventListener("click",(async function(){let e=whatDoc(mainStruct.current);if(e!=PDFDocs.length-1&&!renderInProgress){renderInProgress=!0;const t=fileBuffers[e],n=PDFDocs[e],i=num_pages[e];fileBuffers[e]=fileBuffers[e+1],PDFDocs[e]=PDFDocs[e+1],num_pages[e]=num_pages[e+1],fileBuffers[e+1]=t,PDFDocs[e+1]=n,num_pages[e+1]=i,await renderPDFPage(mainStruct.current),draw(),updatePageCount(),renderInProgress=!1}})),action_button.addEventListener("click",(function(){action()}));